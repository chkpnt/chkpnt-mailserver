---
- name: 'setup (mail-sink)'
  hosts: mail-sink
  tasks:
    - copy: >
        dest=/tmp/maildump content=""
        owner=postfix group=postfix mode='644'
      become: yes

- hosts: sut
  tasks:
    - name: 'Send test mail from SUT'
      shell: echo "Test-Body" | mailx -s "Test" test@mail-sink.theirdomain.test

- hosts: mail-sink
  tasks:
    - name: 'Assert mail has been received'
      compare:
        file: /tmp/maildump
        with_content: |+
          ...
          Received: from sut.mydomain.test ([10.0.3.10])
          ...
          Received: by sut.mydomain.test (Postfix, from userid 1000)
          ...
          Date: $$ .* $$
          To: test@mail-sink.theirdomain.test
          Subject: Test
          ...
          From: vagrant@sut.mydomain.test
          
          Test-Body
          
