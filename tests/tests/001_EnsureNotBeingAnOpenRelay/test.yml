---
- name: 'setup (mail-sink)'
  hosts: client
  tasks:
    - shell: '> ~/dead.letter'
    - shell: '> ~/mail.err'

- hosts: client
  tasks:
    - name: 'Send test mail from client to mail-sink via SUT without authentication'
      shell: |
        echo "Test-Body" | mailx -s "Test" \
        -S smtp=smtp://sut.mydomain.test \
        test@mail-sink.theirdomain.test 2> ~/mail.err

- name: 'Assert mail could not be sent'
  hosts: client
  tasks:
    - compare:
        file: ~/mail.err
        with_content: |
          smtp-server: 554 5.7.1 <test@mail-sink.theirdomain.test>: Relay access denied
          . . . message not sent.
    - compare:
        file: ~/dead.letter
        with_content: |
          Date: $$ .* $$
          From: vagrant@client.localdomain
          To: test@mail-sink.theirdomain.test
          Subject: Test
          ...

          Test-Body