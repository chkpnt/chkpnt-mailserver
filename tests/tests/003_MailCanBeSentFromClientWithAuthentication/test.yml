---
- name: 'setup (mail-sink)'
  hosts: mail-sink
  tasks:
    - copy: >
        dest=/tmp/maildump content=""
        owner=postfix group=postfix mode='644'
      become: yes

- hosts: sut
  tasks:
    - name: 'Send test mail from client to mail-sink via SUT with authentication'
      shell: |
        echo "Test-Body" | mailx -s "Test" \
        -S ssl-verify=ignore \
        -S smtp=smtps://sut.mydomain.test:465 \
        -S smtp-auth=plain \
        -S smtp-auth-user=john.doe@mydomain.test \
        -S smtp-auth-password=changeme \
        test@mail-sink.theirdomain.test

- hosts: mail-sink
  tasks:
    - name: 'Assert mail has been received'
      compare:
        file: /tmp/maildump
        with_content: |+
          ...
          Received: from sut.mydomain.test ([10.0.3.10])
          $$ \t $$by smtp-sink (smtp-sink) with ESMTP id $$ .* $$;
          ...
          Received: from sut.mydomain.test (sut.mydomain.test [127.0.0.1])
          ...
          Date: $$ .* $$
          From: vagrant@sut.mydomain.test
          To: test@mail-sink.theirdomain.test
          Subject: Test
          ...
          
          Test-Body
          
